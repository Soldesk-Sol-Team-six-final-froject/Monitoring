apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      receiver: 'slack-default'
      group_by: ['alertname', 'namespace', 'severity']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      routes:
      # í•„ìš” ì—†ë‹¤ë©´ Watchdogë„ ë“œë¡­ (ì›í•˜ë©´ ì´ ë¸”ë¡ì„ ì£¼ì„ í•´ì œ)
      # - matchers:
      #   - alertname="Watchdog"
      #   receiver: null-receiver

      # ì´ë¯¸ ë“œë¡­í•œ InfoInhibitorë„ ìœ ì§€í•˜ë ¤ë©´ ë‹¤ìŒ ë¼ì¸ ì¶”ê°€
      # - matchers:
      #   - alertname="InfoInhibitor"
      #   receiver: null-receiver

      - matchers:
        - severity="critical"
        receiver: slack-critical
      - matchers:
        - severity="warning"
        receiver: slack-warning

    receivers:
    - name: 'slack-default'
      slack_configs:
      - api_url_file: /etc/alertmanager/secrets/slack-webhook/url
        channel: '#alert-manage'
        send_resolved: true
        title: >-
          [{{ if eq .Status "firing" }}ë°œìƒ{{ else }}í•´ì œ{{ end }}]
          {{ .CommonLabels.alertname }} ({{ or .CommonLabels.severity "n/a" }})
        text: |-
          *ë„¤ì„ìŠ¤í˜ì´ìŠ¤:* {{ or .CommonLabels.namespace "n/a" }}
          *ìš”ì•½:* {{ or .CommonAnnotations.summary .CommonLabels.alertname }}
          *ì„¤ëª…:* {{ or .CommonAnnotations.description "n/a" }}
          {{- range .Alerts }}
          â€¢ *ì•ŒëŒ:* {{ .Labels.alertname }}
            | *ëŒ€ìƒ:* {{ or .Labels.pod .Labels.deployment .Labels.instance .Labels.node "n/a" }}
            {{- if or .Annotations.value .Annotations.threshold }}
            | *í˜„ì¬ê°’:* {{ if .Annotations.value }}{{ .Annotations.value }}{{ if .Annotations.unit }}{{ .Annotations.unit }}{{ end }}{{ end }}
            | *ì„ê³„ê°’:* {{ if .Annotations.threshold }}{{ .Annotations.threshold }}{{ if .Annotations.unit }}{{ .Annotations.unit }}{{ end }}{{ end }}
            {{- end }}
            | *ì‹œì‘:* {{ (.StartsAt | tz "Asia/Seoul") | date "2006-01-02 15:04:05 MST" }}
            | *ì¢…ë£Œ:* {{ if eq .Status "firing" }}ì§„í–‰ ì¤‘{{ else }}{{ (.EndsAt | tz "Asia/Seoul") | date "2006-01-02 15:04:05 MST" }}{{ end }}
          {{- end }}
          *ë¼ë²¨:* {{ .CommonLabels }}

    - name: 'slack-warning'
      slack_configs:
      - api_url_file: /etc/alertmanager/secrets/slack-webhook/url
        channel: '#alert-manage'
        send_resolved: true
        title: "âš ï¸ ê²½ê³ : {{ .CommonLabels.alertname }}"
        text: |-
          {{- range .Alerts }}
          â€¢ ëŒ€ìƒ: {{ or .Labels.pod .Labels.deployment .Labels.instance "n/a" }}
          â€¢ ìš”ì•½: {{ or .Annotations.summary "ì •ë³´ ì—†ìŒ" }}
          â€¢ ì„¤ëª…: {{ or .Annotations.description "ì„¤ëª… ì—†ìŒ" }}
            {{- if or .Annotations.value .Annotations.threshold }}
          â€¢ ì§€í‘œ: í˜„ì¬ {{ if .Annotations.value }}{{ .Annotations.value }}{{ if .Annotations.unit }}{{ .Annotations.unit }}{{ end }}{{ end }} / ì„ê³„ {{ if .Annotations.threshold }}{{ .Annotations.threshold }}{{ if .Annotations.unit }}{{ .Annotations.unit }}{{ end }}{{ end }}
            {{- end }}
          â€¢ ì‹œê°„: ì‹œì‘ {{ (.StartsAt | tz "Asia/Seoul") | date "2006-01-02 15:04:05 MST" }} / {{ if eq .Status "firing" }}ì§„í–‰ ì¤‘{{ else }}ì¢…ë£Œ {{ (.EndsAt | tz "Asia/Seoul") | date "2006-01-02 15:04:05 MST" }}{{ end }}
          {{- end }}

    - name: 'slack-critical'
      slack_configs:
      - api_url_file: /etc/alertmanager/secrets/slack-webhook/url
        channel: '#alert-manage'
        send_resolved: true
        title: "ğŸš¨ ê¸´ê¸‰: {{ .CommonLabels.alertname }}"
        text: |-
          {{- range .Alerts }}
          â€¢ ëŒ€ìƒ: {{ or .Labels.pod .Labels.deployment .Labels.instance "n/a" }}
          â€¢ ìš”ì•½: {{ or .Annotations.summary "ì •ë³´ ì—†ìŒ" }}
          â€¢ ì„¤ëª…: {{ or .Annotations.description "ì„¤ëª… ì—†ìŒ" }}
            {{- if or .Annotations.value .Annotations.threshold }}
          â€¢ ì§€í‘œ: í˜„ì¬ {{ if .Annotations.value }}{{ .Annotations.value }}{{ if .Annotations.unit }}{{ .Annotations.unit }}{{ end }}{{ end }} / ì„ê³„ {{ if .Annotations.threshold }}{{ .Annotations.threshold }}{{ if .Annotations.unit }}{{ .Annotations.unit }}{{ end }}{{ end }}
            {{- end }}
          â€¢ ì‹œê°„: ì‹œì‘ {{ (.StartsAt | tz "Asia/Seoul") | date "2006-01-02 15:04:05 MST" }} / {{ if eq .Status "firing" }}ì§„í–‰ ì¤‘{{ else }}ì¢…ë£Œ {{ (.EndsAt | tz "Asia/Seoul") | date "2006-01-02 15:04:05 MST" }}{{ end }}
          {{- end }}


